name: 'Create Pull Request'
description: 'Create a pull request between source and target branches'
author: 'Pipecraft'

inputs:
  sourceBranch:
    description: 'Source branch for the PR'
    required: true
  targetBranch:
    description: 'Target branch for the PR'
    required: true
  title:
    description: 'Title for the PR'
    required: true
  body:
    description: 'Body/description for the PR'
    required: false
  labels:
    description: 'Comma-separated list of labels'
    required: false
  token:
    description: 'GitHub token for authentication'
    required: false
    default: ${{ github.token }}

outputs:
  prNumber:
    description: 'The created PR number'
    value: ${{ steps.create-pr.outputs.prNumber }}
  prUrl:
    description: 'The created PR URL'
    value: ${{ steps.create-pr.outputs.prUrl }}

runs:
  using: 'composite'
  steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ inputs.token }}

    - name: Check if PR Already Exists
      id: check-existing-pr
      shell: bash
      run: |
        SOURCE="${{ inputs.sourceBranch }}"
        TARGET="${{ inputs.targetBranch }}"
        
        # Check if PR already exists
        EXISTING_PR=$(gh pr list --head "$SOURCE" --base "$TARGET" --json number --jq '.[0].number' 2>/dev/null || echo "")
        
        if [ -n "$EXISTING_PR" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          echo "âš ï¸  PR already exists: #$EXISTING_PR"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "âœ… No existing PR found"
        fi

    - name: Create Pull Request
      if: steps.check-existing-pr.outputs.exists == 'false'
      id: create-pr
      shell: bash
      run: |
        SOURCE="${{ inputs.sourceBranch }}"
        TARGET="${{ inputs.targetBranch }}"
        TITLE="${{ inputs.title }}"
        BODY="${{ inputs.body }}"
        LABELS="${{ inputs.labels }}"
        
        # Prepare labels array
        LABEL_ARGS=""
        if [ -n "$LABELS" ]; then
          IFS=',' read -ra LABEL_ARRAY <<< "$LABELS"
          for label in "${LABEL_ARRAY[@]}"; do
            LABEL_ARGS="$LABEL_ARGS --label \"${label// /}\""
          done
        fi
        
        # Create the PR
        PR_OUTPUT=$(gh pr create \--title "$TITLE" \--body "$BODY" \--head "$SOURCE" \--base "$TARGET" \$LABEL_ARGS \--json number,url --jq '.number,.url' 2>&1)

        if echo "$PR_OUTPUT" | grep -q '"number":'; then
          PR_NUMBER=$(echo "$PR_OUTPUT" | jq -r '.number')
          PR_URL=$(echo "$PR_OUTPUT" | jq -r '.url')
          echo "prNumber=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "prUrl=$PR_URL" >> $GITHUB_OUTPUT
          echo "âœ… Created PR #$PR_NUMBER"
          echo "ğŸ”— URL: $PR_URL"
        else
          echo "âŒ Failed to create PR"
          echo "Error output:"
          echo "$PR_OUTPUT"
          exit 1
        fi

    - name: Use Existing PR
      if: steps.check-existing-pr.outputs.exists == 'true'
      id: use-existing-pr
      shell: bash
      run: |
        PR_NUMBER="${{ steps.check-existing-pr.outputs.pr_number }}"
        PR_URL="https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
        echo "prNumber=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "prUrl=$PR_URL" >> $GITHUB_OUTPUT
        echo "âœ… Using existing PR #$PR_NUMBER"
        echo "ğŸ”— URL: $PR_URL"

    - name: Action Summary
      shell: bash
      run: |
        if [ "${{ steps.create-pr.outputs.prNumber }}" != "" ]; then
          echo "âœ… Successfully created PR #${{ steps.create-pr.outputs.prNumber }}"
          echo "ğŸ”— URL: ${{ steps.create-pr.outputs.prUrl }}"
        elif [ "${{ steps.use-existing-pr.outputs.prNumber }}" != "" ]; then
          echo "â„¹ï¸  Using existing PR #${{ steps.use-existing-pr.outputs.prNumber }}"
          echo "ğŸ”— URL: ${{ steps.use-existing-pr.outputs.prUrl }}"
        else
          echo "âŒ No PR created or found"
        fi